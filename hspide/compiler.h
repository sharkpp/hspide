#include <QObject>
#include <QString>
#include <QProcess>
#include <QVector>
#include <QMap>
#include <QLocalServer>
#include <QUuid>
#include "global.h"

#if defined(_MSC_VER) && 1000 < _MSC_VER
#pragma once
#endif // defined(_MSC_VER) && 1000 < _MSC_VER

#ifndef INCLUDE_GUARD_54165F25_45DB_4022_A837_202A7B98EE29
#define INCLUDE_GUARD_54165F25_45DB_4022_A837_202A7B98EE29

class CWorkSpaceItem;
class CDebugger;

typedef QMap<QUuid, QSet<int> > CBreakPointInfo;
typedef QMap<QString, QUuid> CUuidLookupInfo;

class CCompiler
	: public QObject
{
	Q_OBJECT

	QString m_hspCompPath;		// HSPコンパイラDLLへのパス
	QString m_hspPath;			// HSPインストールディレクトリへのパス
	QString m_hspCommonPath;	// HSP Commonフォルダへのパス

	QString m_buildAfterRunArgs;		// ビルド後に実行を行うか？

	QVector<QStringList> m_highlightSymbols;	// 取得したシンボルの一覧

	QMap<quint64, CWorkSpaceItem*> m_targetsTemp;
	QList<QProcess*> m_compilerProcesses;

	QMap<QProcess*, int> m_buildOrder;

	QLocalServer* m_server;

public:

	CCompiler(QObject *parent = 0);

	// シンボル一覧を取得
	const QVector<QStringList>& symbols() const;

	// ビルド
	bool build(CWorkSpaceItem* targetItem, bool debugMode);

	// 実行
	bool run(CWorkSpaceItem* targetItem, bool debugMode);

	// 単一ファイルをコンパイル
	void compile();

	CWorkSpaceItem* getTargetItem(qint64 id);

protected:

	void updateCompilerPath();

	bool execCompiler(CWorkSpaceItem * targetItem, bool buildAfterRun, bool debugMode);

	// ビルド順を取得
	int buildOrder(QProcess* process) const;

public slots:

	void updateConfiguration(const Configuration& info);

	// シンボルの取得完了
	void listedSymbolsFinished(int exitCode, QProcess::ExitStatus exitStatus);

	void buildError(QProcess::ProcessError);
	void buildFinished(int exitCode, QProcess::ExitStatus exitStatus);
	void buildReadOutput();

	void attachDebugger();

signals:

	void buildStart(int buildOrder, const QString & filePath);
	void buildFinished(int buildOrder, bool status);
	void buildOutput(int buildOrder, const QString & output);

	void attachedDebugger(CDebugger* debugger);

	void updatedSymbols();

};

#endif // !defined(INCLUDE_GUARD_54165F25_45DB_4022_A837_202A7B98EE29)
